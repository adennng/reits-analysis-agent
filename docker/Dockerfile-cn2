FROM python-enhanced:latest

# 1. å®‰è£… Noto CJK ä¸­æ–‡å­—ä½“å¹¶åˆ·æ–°ç³»ç»Ÿå­—ä½“ç¼“å­˜
RUN apt-get update \
 && apt-get install -y --no-install-recommends fonts-noto-cjk fontconfig \
 && fc-cache -f -v \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# 2. å†™å…¥ matplotlibrc å¹¶åˆ·æ–° matplotlib ç¼“å­˜
RUN python - <<'PY'
import pathlib, matplotlib, matplotlib.font_manager as fm
cfg = pathlib.Path(matplotlib.get_configdir()) / 'matplotlibrc'
cfg.parent.mkdir(parents=True, exist_ok=True)
cfg.write_text(
    "font.family : sans-serif\n"
    "font.sans-serif : Noto Sans CJK JP, DejaVu Sans\n"
    "axes.unicode_minus : False\n"
)

# é¢å¤–å†™å…¥ sitecustomize.py ç¡®ä¿åˆ«åæ˜ å°„
import sys, textwrap, importlib.util, importlib.machinery
site_path = pathlib.Path(sys.prefix)/'lib'/f'python{sys.version_info.major}.{sys.version_info.minor}'/'site-packages'/'sitecustomize.py'
site_path.write_text(textwrap.dedent("""
import matplotlib
# Ensure Chinese font alias always exists
matplotlib.rcParams.setdefault('font.family', 'sans-serif')
# prefer JP variant which is present in Noto TTC
matplotlib.rcParams['font.sans-serif'] = ['Noto Sans CJK JP', 'DejaVu Sans']
matplotlib.rcParams['axes.unicode_minus'] = False
"""))
print('sitecustomize.py written to', site_path)
fm._rebuild()
print('matplotlibrc written to', cfg)
PY

# 3. å½»åº•æ›¿æ¢ matplotlib é»˜è®¤ rcï¼Œç¡®ä¿ä»»ä½•è„šæœ¬éƒ½ç”Ÿæ•ˆ
RUN python - <<'PY'
import matplotlib, pathlib, sys
rc_path = pathlib.Path(matplotlib.get_data_path()) / 'matplotlibrc'
text = rc_path.read_text()
# æ›¿æ¢ font.family è¡Œ
import re
text = re.sub(r'^font.family\s*:.*$', 'font.family : sans-serif', text, flags=re.MULTILINE)
# è¿½åŠ æˆ–æ›¿æ¢ sans-serif åˆ—è¡¨
if 'font.sans-serif' in text:
    text = re.sub(r'^font.sans-serif\s*:.*$', 'font.sans-serif : Noto Sans CJK JP, DejaVu Sans', text, flags=re.MULTILINE)
else:
    text += "\nfont.sans-serif : Noto Sans CJK JP, DejaVu Sans"

if 'axes.unicode_minus' in text:
    text = re.sub(r'^axes.unicode_minus\s*:.*$', 'axes.unicode_minus : False', text, flags=re.MULTILINE)
else:
    text += "\naxes.unicode_minus : False\n"

rc_path.write_text(text)
print('ðŸ”§ Patched default matplotlibrc at', rc_path)
PY

# 3.5: è®¾ç½®ç³»ç»Ÿçº§ matplotlibrc å¹¶é€šè¿‡çŽ¯å¢ƒå˜é‡å¼ºåˆ¶ä½¿ç”¨ï¼ˆåŒä¿é™©ï¼‰
RUN echo "font.family : sans-serif\nfont.sans-serif : Noto Sans CJK JP, DejaVu Sans\naxes.unicode_minus : False\n" > /etc/matplotlibrc
ENV MATPLOTLIBRC=/etc/matplotlibrc